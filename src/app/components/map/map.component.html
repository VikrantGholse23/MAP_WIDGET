<div class="map-container">
  <header class="map-header">
    <div class="header-group">
      <label for="metric-select" class="metric-label">Metric</label>
      <select
        id="metric-select"
        class="metric-select"
        [ngModel]="currentMetric"
        (ngModelChange)="currentMetric = $event"
      >
        @for (opt of metricOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>
    <div class="header-group">
      <label for="display-type-select" class="metric-label">Display</label>
      <select
        id="display-type-select"
        class="metric-select"
        [ngModel]="currentDisplayType"
        (ngModelChange)="currentDisplayType = $event"
      >
        @for (opt of displayTypeOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>
    <div class="header-group">
      <label for="base-layer-select" class="metric-label">Map</label>
      <select
        id="base-layer-select"
        class="metric-select"
        [ngModel]="currentBaseLayer"
        (ngModelChange)="currentBaseLayer = $event"
      >
        @for (opt of baseLayerOptions; track opt.value) {
          <option [value]="opt.value">{{ opt.label }}</option>
        }
      </select>
    </div>
  </header>

  <!-- Breadcrumb drill-down: click any segment to jump to that level -->
  <nav class="drilldown-bar" aria-label="Drill-down navigation">
    <button type="button" class="drill-btn breadcrumb-item" (click)="goToWorld()">World</button>
    @if (drillLevel() !== 'country') {
      <span class="drill-sep" aria-hidden="true">›</span>
      <button
        type="button"
        class="drill-btn breadcrumb-item"
        (click)="selectedCountry() && onCountrySelect(selectedCountry()!)"
      >
        {{ selectedCountry() ?? 'Country' }}
      </button>
    }
    @if (drillLevel() === 'country') {
      <span class="drill-sep" aria-hidden="true">›</span>
      <span class="drill-current">Countries (click a region to drill)</span>
    }
    @if (drillLevel() === 'state') {
      <span class="drill-sep" aria-hidden="true">›</span>
      <span class="drill-current">States</span>
      <span class="drill-sep" aria-hidden="true">|</span>
      <label for="state-drill-select" class="drill-label">Jump to state:</label>
      <select id="state-drill-select" class="drill-select" [ngModel]="selectedState()" (ngModelChange)="onStateSelectFromSelect($event)">
        <option value="">— Select state —</option>
        @for (s of states(); track s) {
          <option [value]="s">{{ s }}</option>
        }
      </select>
      <button type="button" class="drill-btn back-btn" (click)="goBackFromState()">← Back</button>
    }
    @if (drillLevel() === 'city') {
      <span class="drill-sep" aria-hidden="true">›</span>
      <span class="drill-current">Cities</span>
      <button type="button" class="drill-btn back-btn" (click)="goBackFromCity()">← Back to states</button>
    }
  </nav>

  <!-- Legend: color scale for current metric -->
  <div class="map-legend" aria-label="Score legend">
    <span class="legend-title">{{ selectedMetric() === 'nps' ? 'NPS' : selectedMetric() === 'csat' ? 'CSAT' : 'CES' }}</span>
    <div class="legend-items">
      @for (r of legendRanges(); track r.color) {
        <span class="legend-item">
          <i class="legend-swatch" [style.background-color]="r.color"></i>
          <span class="legend-label">{{ r.label }}</span>
        </span>
      }
    </div>
  </div>

  @if (loading()) {
    <div class="map-overlay">Loading survey data…</div>
  }
  @if (error()) {
    <div class="map-overlay map-error">{{ error() }}</div>
  }

  <div id="survey-map" class="survey-map"></div>
</div>
